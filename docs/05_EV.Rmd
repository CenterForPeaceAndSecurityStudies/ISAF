---
title: "05_EV"
author: "Daniel Kent"
date: "August 14, 2018"
output: html_document
---


# Baseline data

First, we load the data for 2001-2012. This is a cleaned version of the national military capabilities dataset, which serves as a nice starting point because we are generally interested in contributions relative to a country's total military capacity.

It is worth noting that we have troop data for Afghanistan through 2014, so we may have to revisit this setup to see if we can find a way to get our right-hand side through 2014.

```{R}
isaf <- rio::import('inst/extdata/isaf_rhs.rds')
```

# Ideal Points

Second, let's merge the Bailey et al. ideal point measures.

```{R}
## import data
ideal <- rio::import('inst/extdata/voeten_un_votes/idealpoints.csv')

## prep for merging by removing unwanted variables
ideal <- dplyr::select(ideal, c(ccode, year, CountryName, Idealpoint, PctAgreeUS))
colnames(ideal) <- c("ccode", "year", "statenme", "idealpoint", "pctagreeus")

## merge data
isaf <- dplyr::left_join(isaf, ideal)
```

# Lebovic and Saunders

Second, let's add the the Lebovic and Saunders data on diplomatic visits. This only goes to 2012.

```{R}
diplomatic <- rio::import('inst/extdata/lebovich_saunders_diplomacy/dipl_core.csv')

## There is a lot going on here. Let's just look at US visits and arms relations.
dipl <- dplyr::select(diplomatic, c(cowid, year, bi_SOS, bi_PRE, bi_str_SOS,
                    bi_str_PRE, USmilaid, allies, USdefense,
                    UStrade, USalign, UNpart))

## colnames that make more sense
colnames(dipl) <- c("ccode", "year", "sec_st", "pres", "sec_only", "pres_only",
                    "us_mil_aid", "us_ally", "us_def_pact", "us_trade",
                    "us_un_vote_sim", "un_particip")

## merge datasets
isaf <- dplyr::left_join(isaf, dipl)
```

# Kinne

This is a cleaned version of the original dataset, as the original was too large for GitHub and contained variables and observations we did not need. Note that this data ends in 2010.

```{R}
kinne <- rio::import('inst/extdata/kinne_defense_cooperation_agreements/kinne_dca.rds')

isaf <- dplyr::left_join(isaf, kinne)
```

# Network measures

Let's also build the alliance network for each year so that we can calculate statistics for network position. Note, it is OK that this only includes states with an alliance. Any state not in the alliance network will be categorized as an NA for network statistics.


```{R}
allies <- rio::import('inst/extdata/alliance_v4.1_by_dyad_yearly.csv')

## All forms of alliances, not just defense
ally <- dplyr::select(allies, c(ccode1, state_name1, ccode2, state_name2, year,
                                defense, neutrality, nonaggression, entente))

## Create a list with spots for each year
ally_nets <- list()

## General nodel-level attributes
ccodes <- rio::import('inst/extdata/ccodes.csv')
colnames(ccodes) <- c("stateabb", "ccode", "statenme")
nodes <- dplyr::select(ccodes, c(ccode, stateabb))


for(i in 1816:2012){
    ## Thanks to Skyler Cranmer for much of this code.
    temp <- dplyr::filter(ally, year == i)

    ## Edgelist
    state1 <- dplyr::select(temp, c(ccode1))
    state1 <- dplyr::left_join(state1, nodes, by = c("ccode1" = "ccode"))
    colnames(state1) <- c("ccode1", "stateabb1")

    state2 <- dplyr::select(temp, c(ccode2))
    state2 <- dplyr::left_join(state2, nodes, by = c("ccode2" = "ccode"))
    colnames(state2) <- c("ccode2", "stateabb2")

    edgelist <- dplyr::tibble(state1$stateabb1, state2$stateabb2)
    colnames(edgelist) <- c("V1", "V2")

    ## Vertices
    vertices <- unique(c(state1$stateabb1, state2$stateabb2))
    allyV <- dplyr::filter(nodes, stateabb %in% vertices)

    ## Number of vertices
    n <- length(vertices)

    ## Initialize the network
    allynet <- network::network.initialize(n, dir = FALSE)

    ## Set vertex names
    network::network.vertex.names(allynet) <- allyV$stateabb

    ## Add in edges
    ## Note, edgelist must match vertex labels
    allynet[as.matrix(edgelist)]  <- 1

    ## Set country code as an attribute
    set.vertex.attribute(x=allynet, # Network in which to store
            "ccode",                # What to name the attribute
            allyV$ccode)            # Values to put in

    ## list store
    iteration <- i - 1815
    ally_nets[[iteration]] <- allynet
}
```

For the purposes of this project, let's just save the 2001-2012 networks. Note, to load correctly, one needs to import the network package first.

```{R}
isaf_alliance_nets <- ally_nets[186:197]
rlist::list.save(isaf_alliance_nets, file = "data/alliance_networks.RData")
```

## Network statistics

We can now calculate statistics for a node's network position each year and input them into the isaf dataset.

```{R}
test <- sna::evcent(isaf_alliance_nets[[1]])
## What are the states?
get.vertex.attribute(isaf_alliance_nets[[1]], "vertex.names")

nettest <- intergraph::asIgraph(isaf_alliance_nets[[1]])
test2 <- igraph::transitivity(nettest,type="local")
## NaNs are those with no closed triples.

## create an ongoing tibble (append year after year) with each measure and ccode

netstats <- dplyr::tibble(ccode = integer(),
                          eigen = numeric(),
                          clustercoef = numeric(),
                          degree = integer(),
                          year = integer())

for(i in 1:length(isaf_alliance_nets)){
    eigen <- sna::evcent(isaf_alliance_nets[[i]])
    ccode <- network::get.vertex.attribute(
                isaf_alliance_nets[[i]], "ccode")
    graph <- intergraph::asIgraph(isaf_alliance_nets[[i]])
    clustercoef <- igraph::transitivity(graph, type="local")
    degree <- igraph::degree(graph)
    netmeasures <- dplyr::tibble(ccode, eigen, clustercoef, degree)
    netmeasures$year <- i + 2000
    netstats <- rbind(netstats, netmeasures)
}
```

Last, we merge the network stats with isaf. Note we can calculate any network statistic we want at this point and merge on easily.

```{R}
isaf <- dplyr::left_join(isaf, netstats)
```

# DV

Let's import the iiss data about troop levels in Afghanistan.

```{R}
iiss_troops <- rio::import('data/iiss_afghan.rds')
iiss_troops <- dplyr::arrange(iiss_troops, year)
```

# Merge

Now we can merge everything together.

```{R}
iiss_troops$ccode <- as.integer(iiss_troops$ccode)
final_data <- dplyr::left_join(iiss_troops, isaf)
```

# Finalize

Last, let's clean everything up.

```{R}
colnames(final_data)

final_data <- dplyr::select(final_data, -c(statenme))
final_data <- dplyr::select(final_data, c(year, country, stateabb, ccode,
        troops_total, troops_afghan_total, troops_afghan_oef, troops_afghan_isaf,
        troops_afghan_unama, troops_afghan_ratio, milex, milper, irst, pec, tpop,
        upop, cinc, idealpoint, pctagreeus, us_un_vote_sim, un_particip, sec_st,
        pres, sec_only, pres_only, ambassador, us_mil_aid, us_ally, us_def_pact,
        us_trade, dca, dca_ongoing, abs_ideal_diff, arms_imports, NATO,
        eigen, clustercoef, degree))
```

# Save files

```{R}
iiss_rhs <- dplyr::select(final_data, -c(troops_total, troops_afghan_total,
                        troops_afghan_oef, troops_afghan_isaf,
                        troops_afghan_unama, troops_afghan_ratio))

## right hand side data
rio::export(iiss_rhs, 'data/iiss_afghan_rhs.rds')
## merged complete data
rio::export(final_data, 'data/iiss_afghan_complete.rds')
```


