---
title: "Model Building"
author: Gannon and Kent
output: html_document
---

# Steps

1. Load ISAF Data
2. Descriptive statistics
3. Models
  3a. Why contribute amount of troops?
  3b. Does it pay off?

# Data loading

```{R}
isaf <- rio::import('../data/iiss_afghan_complete.rds')
## Remove afghanistan because it is not a realistic self-contributor
## Remove US because paper is about relations with the US
isaf <- dplyr::filter(isaf, stateabb != "AFG" & stateabb != "USA")
```

+ Until we sort out the Iceland data (they are listed as having no available troops in most sources, but did send people to Afghanistan), let's drop those observations. Once we update the Iceland data we can re-estimate all models.

```{R}
isaf <- dplyr::filter(isaf, stateabb != "ICE")
```

# Description and visualization

+ Note that as constructed, the `pot_gain` variable considers countries without a US alliance as NA. To remedy this, let's rescale `pot_gain` so that countries without a US alliance are at the minimum. 

```{R}
## First, recode to be from 0 to max.
isaf$pot_gain_recode <- isaf$pot_gain - summary(isaf$pot_gain)[1]

## Any NA's become 0
isaf$pot_gain_recode <- ifelse(
  is.na(isaf$pot_gain_recode), 
  0, 
  isaf$pot_gain_recode
  )
```

```{R}
## Remove id variables
descrip <- dplyr::select(isaf, -c(year, country, ccode, stateabb))
## Descriptive grid
GGally::ggpairs(dplyr::select(descrip, 
  -c(troops_total, troops_afghan_total, troops_afghan_oef, troops_afghan_isaf,
  troops_afghan_unama, milex, milper, irst, pec, tpop, upop, atopid, pot_gain,
  gdp, gdppc, casualties, distance))) + ggplot2::theme_bw()
```

+ Ok, so looks good. Some important points to consider. Notice that, by construction, `idealpoint` and `pctagreeus` are strongly associated with `pot_gain`. 

# Models

```{R}
m1 <- glm(troops_afghan_ratio ~ pot_gain_recode, 
  data = isaf) 
  ## unnecessary to filter by us ally, because gets dropped, but I want 
  ## to keep track of the data partitions
summary(m1)

m2 <- glm(troops_afghan_ratio ~ pctagreeus,
  data = dplyr::filter(isaf, us_ally == 0))
summary(m2)

## Remove for now
m3 <- glm(troops_afghan_ratio ~ pctagreeus,
  data = isaf)
summary(m3)

## Keeping out gdp and gdppc because they drop so many observations
full_form <- as.formula(
  troops_afghan_ratio ~ pot_gain_recode + pctagreeus + idealpoint + dem + 
  distance + casualties + us_ally + cinc
  )

m4 <- glm(
  full_form,
  data = isaf)
summary(m4)
## Cool -- variables have expected direction, but potential gain has arguably largest size.

## fixed effects? Same coefficient as m1
m5 <- plm::plm(full_form,
  model = "within",
  index = c("ccode", "year"),
  data = isaf)
summary(m5)
```

+ Note that the max contribution is 0.057381, the mean is 0.0018, and the median is 0. So a range of 0 to 0.01225 is not minimal. 

+ How does the model fit? Not ideal, but we can work on it.

```{R}
library(ggplot2) ## easier to load ggplot than call before each function
ggplot(m4) + 
    geom_point(aes(x=.fitted, y=.resid)) + 
    theme_classic() + 
    labs(title = "Residuals Versus Fitted Values",
        x = "Fitted Values",
        y = "Residuals")
```

+ Predicted contributions? Set all variables to mean and predict range.
